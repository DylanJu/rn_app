"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const LayoutType_1 = require("./LayoutType");
class LayoutTreeCrawler {
    constructor(uniqueIdProvider, store, optionsProcessor) {
        this.uniqueIdProvider = uniqueIdProvider;
        this.store = store;
        this.optionsProcessor = optionsProcessor;
        this.crawl = this.crawl.bind(this);
    }
    crawl(node) {
        node.id = node.id || this.uniqueIdProvider.generate(node.type);
        if (node.type === LayoutType_1.LayoutType.Component) {
            this._handleComponent(node);
        }
        this.optionsProcessor.processOptions(node.data.options);
        _.forEach(node.children, this.crawl);
    }
    _handleComponent(node) {
        this._assertComponentDataName(node);
        this._savePropsToStore(node);
        this._applyStaticOptions(node);
        node.data.passProps = undefined;
    }
    _savePropsToStore(node) {
        this.store.setPropsForId(node.id, node.data.passProps);
    }
    _applyStaticOptions(node) {
        const clazz = this.store.getComponentClassForName(node.data.name) ? this.store.getComponentClassForName(node.data.name)() : {};
        const staticOptions = _.isFunction(clazz.options) ? clazz.options(node.data.passProps || {}) : (_.cloneDeep(clazz.options) || {});
        const passedOptions = node.data.options || {};
        node.data.options = _.merge({}, staticOptions, passedOptions);
    }
    _assertComponentDataName(component) {
        if (!component.data.name) {
            throw new Error('Missing component data.name');
        }
    }
}
exports.LayoutTreeCrawler = LayoutTreeCrawler;
